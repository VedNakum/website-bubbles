<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Homework Bubbles</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .pop { animation: pop 180ms ease-out; }
    @keyframes pop { 0%{transform:scale(.96); opacity:.6} 100%{transform:scale(1); opacity:1} }
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.6); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-indigo-50 to-emerald-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Homework Bubbles</h1>
        <p class="text-sm text-slate-600">Type on one device, instantly shows on another.</p>
      </div>
      <div class="flex items-center gap-2 w-full sm:w-auto">
        <input id="roomInput" placeholder="Room code (e.g., ved-home)" class="w-full sm:w-56 px-3 py-2 rounded-xl border border-slate-300 bg-white/80" />
        <button id="saveRoomBtn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white shadow hover:bg-indigo-500 active:scale-[.98]">Use</button>
      </div>
    </header>

    <div class="mb-4 grid grid-cols-2 gap-2">
      <button id="writerBtn" class="rounded-2xl glass px-4 py-2 shadow border border-white/50 font-medium">‚úçÔ∏è Input (school iPad)</button>
      <button id="displayBtn" class="rounded-2xl glass px-4 py-2 shadow border border-white/50 font-medium">üñºÔ∏è Display (home iPad)</button>
    </div>

    <section id="writerView" class="space-y-4">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="block text-sm font-semibold mb-1">Subject</label>
          <select id="subject" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white/80">
            <option value="Physics">Physics</option>
            <option value="Math">Math</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Biology">Biology</option>
            <option value="English">English</option>
            <option value="History">History</option>
            <option value="CS">CS</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold mb-1">Homework</label>
          <input id="text" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white/80" placeholder="e.g., Physics: finish #12‚Äì20, show work" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Due (optional)</label>
          <input id="due" type="datetime-local" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white/80" />
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button id="addBtn" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white shadow hover:bg-emerald-500 active:scale-[.98]">Add Bubble</button>
          <button id="quickAddSample" class="px-4 py-2 rounded-2xl bg-slate-800 text-white shadow hover:bg-slate-700 active:scale-[.98]">Quick sample</button>
        </div>
      </div>
      <details class="rounded-2xl glass p-4 shadow border border-white/50">
        <summary class="cursor-pointer font-semibold">Paste today‚Äôs schedule (one per line)</summary>
        <div class="mt-3 flex flex-col gap-2">
          <textarea id="bulk" rows="4" placeholder="Physics ‚Äî p.132 #12‚Äì20\nMath ‚Äî worksheet 5B\nEnglish ‚Äî outline intro paragraph" class="px-3 py-2 rounded-xl border border-slate-300 bg-white/80"></textarea>
          <div class="flex items-center gap-2">
            <select id="bulkSubject" class="px-3 py-2 rounded-xl border border-slate-300 bg-white/80">
              <option value="Auto-detect">Auto-detect (first word)</option>
              <option value="Physics">Physics</option>
              <option value="Math">Math</option>
              <option value="Chemistry">Chemistry</option>
              <option value="Biology">Biology</option>
              <option value="English">English</option>
              <option value="History">History</option>
              <option value="CS">CS</option>
              <option value="Other">Other</option>
            </select>
            <button id="bulkAddBtn" class="px-3 py-2 rounded-2xl bg-indigo-600 text-white shadow hover:bg-indigo-500 active:scale-[.98]">Add Lines</button>
          </div>
        </div>
      </details>
      <div>
        <h2 class="text-lg font-semibold mb-2">Live preview (what the other iPad sees)</h2>
        <div id="writerList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      </div>
    </section>

    <section id="displayView" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold">Today‚Äôs Homework</h2>
        <button id="clearDoneBtn" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">Clear completed</button>
      </div>
      <div id="displayList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      <div>
        <h3 class="text-lg font-semibold mt-4">Completed</h3>
        <div id="doneList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-2"></div>
      </div>
    </section>

    <footer class="mt-10 text-xs text-slate-500">Tip: set this page to full-screen on your home iPad. Use the same room code on both devices.</footer>
  </div>

  <!-- Supabase SDK -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    // Using your project details (‚ö†Ô∏è this is your anon public key, safe for frontend use)
    const SUPABASE_URL = "https://ednokgrknummhlcdunzl.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkbm9rZ3JrbnVtbWhsY2R1bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTI5MjgsImV4cCI6MjA3Mjg2ODkyOH0.voMMeOVxBNkLL0ehqyD1as9He2_nykm8rUGthtvTgyQ"
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    // Elements
    const writerBtn = document.getElementById('writerBtn');
    const displayBtn = document.getElementById('displayBtn');
    const writerView = document.getElementById('writerView');
    const displayView = document.getElementById('displayView');

    const roomInput = document.getElementById('roomInput');
    const saveRoomBtn = document.getElementById('saveRoomBtn');

    const subjectEl = document.getElementById('subject');
    const textEl = document.getElementById('text');
    const dueEl = document.getElementById('due');
    const addBtn = document.getElementById('addBtn');
    const quickAddSample = document.getElementById('quickAddSample');

    const bulk = document.getElementById('bulk');
    const bulkSubject = document.getElementById('bulkSubject');
    const bulkAddBtn = document.getElementById('bulkAddBtn');

    const writerList = document.getElementById('writerList');
    const displayList = document.getElementById('displayList');
    const doneList = document.getElementById('doneList');
    const clearDoneBtn = document.getElementById('clearDoneBtn');

    let ROOM = localStorage.getItem('roomCode') || 'ved-home';
    roomInput.value = ROOM;

    function setMode(mode) {
      const isWriter = mode === 'writer';
      writerView.classList.toggle('hidden', !isWriter);
      displayView.classList.toggle('hidden', isWriter);
      writerBtn.classList.toggle('bg-white', isWriter);
      displayBtn.classList.toggle('bg-white', !isWriter);
      const url = new URL(window.location);
      url.searchParams.set('view', mode);
      window.history.replaceState({}, '', url);
    }

    const viewParam = new URLSearchParams(location.search).get('view');
    setMode(viewParam === 'display' ? 'display' : 'writer');

    writerBtn.onclick = () => setMode('writer');
    displayBtn.onclick = () => setMode('display');

    saveRoomBtn.onclick = () => {
      ROOM = (roomInput.value || '').trim() || 'default';
      localStorage.setItem('roomCode', ROOM);
      subscribeToRoom();
      saveRoomBtn.textContent = '‚úì Using';
      setTimeout(() => (saveRoomBtn.textContent = 'Use'), 1200);
    };

    function colorFor(subj) {
      const map = {
        Physics: 'from-rose-200 to-rose-100 border-rose-300',
        Math: 'from-sky-200 to-sky-100 border-sky-300',
        Chemistry: 'from-lime-200 to-lime-100 border-lime-300',
        Biology: 'from-emerald-200 to-emerald-100 border-emerald-300',
        English: 'from-amber-200 to-amber-100 border-amber-300',
        History: 'from-orange-200 to-orange-100 border-orange-300',
        CS: 'from-violet-200 to-violet-100 border-violet-300',
        Other: 'from-slate-200 to-slate-100 border-slate-300'
      };
      return map[subj] || map.Other;
    }

    function bubble({ id, subject, text, due, done }) {
      const dueText = due ? new Date(due).toLocaleString() : '';
      const card = document.createElement('div');
      card.className = `pop rounded-2xl border bg-gradient-to-b ${colorFor(subject)} p-3 shadow`;
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="text-xs uppercase tracking-wide font-semibold text-slate-700/80">${subject}</div>
            <div class="font-medium break-words ${done ? 'line-through opacity-60' : ''}">${text}</div>
            ${dueText ? `<div class="text-xs mt-1">Due: ${dueText}</div>` : ''}
          </div>
          <div class="flex items-center gap-1 shrink-0">
            <button data-act="toggle" class="px-2 py-1 rounded-lg bg-white/70 border">${done ? '‚Ü©Ô∏é' : '‚úì'}</button>
            <button data-act="del" class="px-2 py-1 rounded-lg bg-white/70 border">üóëÔ∏è</button>
          </div>
        </div>`;

      card.querySelector('[data-act="toggle"]').onclick = async () => {
        await supabase.from('homework').update({ done: !done }).eq('id', id)
      }
      card.querySelector('[data-act="del"]').onclick = async () => {
        await supabase.from('homework').delete().eq('id', id)
      }
      return card;
    }

    async function renderLists() {
      const { data } = await supabase.from('homework').select('*').eq('room', ROOM)
      const items = data || []
      const active = items.filter(i => !i.done)
      const completed = items.filter(i => i.done)

      writerList.innerHTML = '';
      active.forEach(i => writerList.appendChild(bubble(i)));

      displayList.innerHTML = '';
      active.forEach(i => displayList.appendChild(bubble(i)));

      doneList.innerHTML = '';
      completed.forEach(i => doneList.appendChild(bubble(i)));
    }

    async function subscribeToRoom() {
      supabase.channel('room-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'homework', filter: `room=eq.${ROOM}` }, renderLists)
        .subscribe()
      renderLists()
    }

    addBtn.onclick = async () => {
      const subject = subjectEl.value.trim() || 'Other';
      const text = textEl.value.trim();
      const due = dueEl.value ? new Date(dueEl.value).toISOString() : null;
      if (!text) return;
      await supabase.from('homework').insert([{ subject, text, due, done: false, room: ROOM }])
      textEl.value = '';
      dueEl.value = '';
    }

    quickAddSample.onclick = async () => {
      const samples = [
        {subject:'Physics', text:'Finish p.132 #12‚Äì20, show work'},
        {subject:'Math', text:'Worksheet 5B odd numbers'},
        {subject:'English', text:'Outline intro paragraph; bring book'}
      ];
      for (const s of samples) await supabase.from('homework').insert([{ ...s, due: null, done:false, room: ROOM }])
    }

    bulkAddBtn.onclick = async () => {
      const lines = bulk.value.split(/\n+/).map(l => l.trim()).filter(Boolean);
      const mode = bulkSubject.value;
      for (const line of lines) {
        let subject = 'Other', text = line;
        if (mode === 'Auto-detect') {
          const m = line.match(/^(\w+)[\s:‚Äî-]+(.+)/);
          if (m) { subject = m[1]; text = m[2]; }
        } else subject = mode;
        await supabase.from('homework').insert([{ subject, text, due:null, done:false, room: ROOM }])
      }
      bulk.value = '';
    }

    clearDoneBtn.onclick = async () => {
      await supabase.from('homework').delete().eq('room', ROOM).eq('done', true)
    }

    subscribeToRoom()

    setInterval(() => {
      window.location.reload()
    }, 60000)
  </script>
</body>
</html>
